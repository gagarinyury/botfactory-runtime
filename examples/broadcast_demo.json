{
  "use": [
    "flow.wizard.v1",
    "action.sql_exec.v1",
    "action.sql_query.v1",
    "action.reply_template.v1",
    "ops.broadcast.v1"
  ],
  "intents": [
    {"cmd": "/start", "reply": "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ö–æ–º–∞–Ω–¥—ã: /promo, /send_newsletter, /user_stats"}
  ],
  "flows": [
    {
      "type": "flow.wizard.v1",
      "entry_cmd": "/promo",
      "params": {
        "steps": [
          {
            "ask": "–ö–∞–∫–∞—è —Å–∫–∏–¥–∫–∞? (–≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 5 –¥–æ 50)",
            "var": "discount",
            "validate": {
              "regex": "^([5-9]|[1-4][0-9]|50)$",
              "msg": "–°–∫–∏–¥–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 5 –¥–æ 50 –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤"
            }
          },
          {
            "ask": "–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å? (all/active_7d/segment:vip_users)",
            "var": "audience",
            "validate": {
              "regex": "^(all|active_7d|segment:[a-zA-Z0-9_]+)$",
              "msg": "–ê—É–¥–∏—Ç–æ—Ä–∏—è: all, active_7d –∏–ª–∏ segment:–∏–º—è_—Å–µ–≥–º–µ–Ω—Ç–∞"
            }
          }
        ],
        "on_complete": [
          {
            "type": "ops.broadcast.v1",
            "params": {
              "audience": "{{audience}}",
              "message": "t:broadcast.promo {discount={{discount}}}",
              "throttle": {"per_sec": 25},
              "track_metrics": true
            }
          },
          {
            "type": "action.reply_template.v1",
            "params": {
              "text": "‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞!\n\n–ê—É–¥–∏—Ç–æ—Ä–∏—è: {{audience}}\n–°–∫–∏–¥–∫–∞: {{discount}}%\n\n–°—Ç–∞—Ç—É—Å –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –∞–¥–º–∏–Ω–∫–µ."
            }
          }
        ]
      }
    },
    {
      "type": "flow.wizard.v1",
      "entry_cmd": "/send_newsletter",
      "params": {
        "on_enter": [
          {
            "type": "action.sql_query.v1",
            "params": {
              "sql": "SELECT COUNT(*) as active_users FROM bot_users WHERE bot_id=:bot_id AND is_active=true AND last_active >= NOW() - INTERVAL '7 days'",
              "result_var": "stats",
              "scalar": true
            }
          }
        ],
        "steps": [
          {
            "ask": "–¢–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏:",
            "var": "newsletter_text"
          },
          {
            "ask": "–°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ (—Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É, 1-50):",
            "var": "send_rate",
            "validate": {
              "regex": "^([1-9]|[1-4][0-9]|50)$",
              "msg": "–°–∫–æ—Ä–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 1 –¥–æ 50 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É"
            }
          }
        ],
        "on_complete": [
          {
            "type": "ops.broadcast.v1",
            "params": {
              "audience": "active_7d",
              "message": "{{newsletter_text}}",
              "throttle": {"per_sec": "{{send_rate}}"}
            }
          },
          {
            "type": "action.reply_template.v1",
            "params": {
              "text": "üì® –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è!\n\n–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {{stats}}\n–¢–µ–∫—Å—Ç: {{newsletter_text}}\n–°–∫–æ—Ä–æ—Å—Ç—å: {{send_rate}} —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫"
            }
          }
        ]
      }
    },
    {
      "type": "flow.wizard.v1",
      "entry_cmd": "/user_stats",
      "params": {
        "on_enter": [
          {
            "type": "action.sql_query.v1",
            "params": {
              "sql": "SELECT COUNT(*) as total FROM bot_users WHERE bot_id=:bot_id AND is_active=true",
              "result_var": "total_users",
              "scalar": true
            }
          },
          {
            "type": "action.sql_query.v1",
            "params": {
              "sql": "SELECT COUNT(*) as active FROM bot_users WHERE bot_id=:bot_id AND is_active=true AND last_active >= NOW() - INTERVAL '7 days'",
              "result_var": "active_7d",
              "scalar": true
            }
          },
          {
            "type": "action.sql_query.v1",
            "params": {
              "sql": "SELECT COUNT(*) as vip FROM bot_users WHERE bot_id=:bot_id AND is_active=true AND 'vip_users' = ANY(segment_tags)",
              "result_var": "vip_count",
              "scalar": true
            }
          },
          {
            "type": "action.sql_query.v1",
            "params": {
              "sql": "SELECT status, COUNT(*) as count FROM broadcasts WHERE bot_id=:bot_id AND created_at >= NOW() - INTERVAL '30 days' GROUP BY status ORDER BY status",
              "result_var": "broadcast_stats"
            }
          },
          {
            "type": "action.reply_template.v1",
            "params": {
              "text": "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:\n\nüë• –í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö: {{total_users}}\nüî• –ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞ 7 –¥–Ω–µ–π: {{active_7d}}\n‚≠ê VIP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {{vip_count}}\n\nüì® –†–∞—Å—Å—ã–ª–∫–∏ –∑–∞ 30 –¥–Ω–µ–π:\n{{#each broadcast_stats}}‚Ä¢ {{status}}: {{count}}\n{{/each}}",
              "empty_text": "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:\n\nüë• –í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö: {{total_users}}\nüî• –ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞ 7 –¥–Ω–µ–π: {{active_7d}}\n‚≠ê VIP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {{vip_count}}\n\nüì® –†–∞—Å—Å—ã–ª–æ–∫ –∑–∞ 30 –¥–Ω–µ–π –Ω–µ –±—ã–ª–æ",
              "keyboard": [
                {"text": "üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É", "callback": "/send_newsletter"},
                {"text": "üéÅ –ü—Ä–æ–º–æ-–∞–∫—Ü–∏—è", "callback": "/promo"},
                {"text": "üîô –ì–ª–∞–≤–Ω–∞—è", "callback": "/start"}
              ]
            }
          }
        ]
      }
    },
    {
      "type": "flow.wizard.v1",
      "entry_cmd": "/segment_promo",
      "params": {
        "steps": [
          {
            "ask": "–ò–º—è —Å–µ–≥–º–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: premium_users, new_customers):",
            "var": "segment_name",
            "validate": {
              "regex": "^[a-zA-Z0-9_]+$",
              "msg": "–ò–º—è —Å–µ–≥–º–µ–Ω—Ç–∞: —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ"
            }
          },
          {
            "ask": "–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:",
            "var": "personal_message"
          }
        ],
        "on_complete": [
          {
            "type": "action.sql_query.v1",
            "params": {
              "sql": "SELECT COUNT(*) as segment_size FROM bot_users WHERE bot_id=:bot_id AND is_active=true AND :segment_name = ANY(segment_tags)",
              "result_var": "segment_size",
              "scalar": true
            }
          },
          {
            "type": "ops.broadcast.v1",
            "params": {
              "audience": "segment:{{segment_name}}",
              "message": "t:broadcast.personal {message={{personal_message}}}",
              "throttle": {"per_sec": 20}
            }
          },
          {
            "type": "action.reply_template.v1",
            "params": {
              "text": "üéØ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞!\n\n–°–µ–≥–º–µ–Ω—Ç: {{segment_name}}\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {{segment_size}}\n–°–æ–æ–±—â–µ–Ω–∏–µ: {{personal_message}}"
            }
          }
        ]
      }
    }
  ]
}