{
  "use": [
    "flow.wizard.v1",
    "policy.ratelimit.v1",
    "action.sql_exec.v1",
    "action.sql_query.v1",
    "action.reply_template.v1"
  ],
  "intents": [
    {"cmd": "/help", "reply": "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: /start, /book, /feedback, /status"}
  ],
  "flows": [
    {
      "type": "flow.wizard.v1",
      "entry_cmd": "/start",
      "params": {
        "on_enter": [
          {
            "type": "policy.ratelimit.v1",
            "params": {
              "scope": "user",
              "window_s": 30,
              "allowance": 3,
              "key_suffix": "{{entry_cmd}}",
              "message": "–°–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ /start. –ü–æ–¥–æ–∂–¥–∏—Ç–µ {{retry_in}} —Å–µ–∫—É–Ω–¥."
            }
          },
          {
            "type": "action.reply_template.v1",
            "params": {
              "text": "ü§ñ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!\n\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n‚Ä¢ /book - –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —É—Å–ª—É–≥—É\n‚Ä¢ /feedback - –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤\n‚Ä¢ /status - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å\n\n–†–∞–∑—Ä–µ—à–µ–Ω–æ 3 –∑–∞–ø—É—Å–∫–∞ /start –≤ 30 —Å–µ–∫—É–Ω–¥."
            }
          }
        ]
      }
    },
    {
      "type": "flow.wizard.v1",
      "entry_cmd": "/book",
      "params": {
        "on_enter": [
          {
            "type": "policy.ratelimit.v1",
            "params": {
              "scope": "user",
              "window_s": 120,
              "allowance": 1,
              "key_suffix": "booking",
              "message": "‚è∞ –û–¥–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ 2 –º–∏–Ω—É—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ {{retry_in}} —Å–µ–∫."
            }
          }
        ],
        "steps": [
          {
            "ask": "–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É: –º–∞—Å—Å–∞–∂/–º–∞–Ω–∏–∫—é—Ä/—Å—Ç—Ä–∏–∂–∫–∞",
            "var": "service",
            "validate": {
              "regex": "^(–º–∞—Å—Å–∞–∂|–º–∞–Ω–∏–∫—é—Ä|—Å—Ç—Ä–∏–∂–∫–∞)$",
              "msg": "–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞: –º–∞—Å—Å–∞–∂, –º–∞–Ω–∏–∫—é—Ä, —Å—Ç—Ä–∏–∂–∫–∞"
            }
          },
          {
            "ask": "–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è (YYYY-MM-DD HH:MM)",
            "var": "slot",
            "validate": {
              "regex": "^\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}$",
              "msg": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: YYYY-MM-DD HH:MM"
            }
          }
        ],
        "on_step": [
          {
            "type": "policy.ratelimit.v1",
            "params": {
              "scope": "user",
              "window_s": 60,
              "allowance": 2,
              "key_suffix": "step:{{service}}",
              "message": "üõë –°–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ –∑–∞–ø–æ–ª–Ω—è–µ—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è {{service}}. –ü–æ–¥–æ–∂–¥–∏—Ç–µ {{retry_in}} —Å–µ–∫."
            }
          }
        ],
        "on_complete": [
          {
            "type": "action.sql_exec.v1",
            "params": {
              "sql": "INSERT INTO bookings(bot_id, user_id, service, slot, created_at) VALUES(:bot_id, :user_id, :service, to_timestamp(:slot, 'YYYY-MM-DD HH24:MI'), NOW())"
            }
          },
          {
            "type": "action.reply_template.v1",
            "params": {
              "text": "‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞!\n\nüìã –î–µ—Ç–∞–ª–∏:\n‚Ä¢ –£—Å–ª—É–≥–∞: {{service}}\n‚Ä¢ –í—Ä–µ–º—è: {{slot}}\n\n‚è∞ –°–ª–µ–¥—É—é—â–µ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —á–µ—Ä–µ–∑ 2 –º–∏–Ω—É—Ç—ã."
            }
          }
        ]
      }
    },
    {
      "type": "flow.wizard.v1",
      "entry_cmd": "/feedback",
      "params": {
        "on_enter": [
          {
            "type": "policy.ratelimit.v1",
            "params": {
              "scope": "user",
              "window_s": 300,
              "allowance": 2,
              "key_suffix": "feedback",
              "message": "üìù –ù–µ –±–æ–ª–µ–µ 2 –æ—Ç–∑—ã–≤–æ–≤ –≤ 5 –º–∏–Ω—É—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ {{retry_in}} —Å–µ–∫."
            }
          }
        ],
        "steps": [
          {
            "ask": "–û—Ü–µ–Ω–∏—Ç–µ —Å–µ—Ä–≤–∏—Å –æ—Ç 1 –¥–æ 5",
            "var": "rating",
            "validate": {
              "regex": "^[1-5]$",
              "msg": "–í–≤–µ–¥–∏—Ç–µ –æ—Ü–µ–Ω–∫—É –æ—Ç 1 –¥–æ 5"
            }
          },
          {
            "ask": "–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)",
            "var": "comment"
          }
        ],
        "on_complete": [
          {
            "type": "action.sql_exec.v1",
            "params": {
              "sql": "INSERT INTO feedback(bot_id, user_id, rating, comment, created_at) VALUES(:bot_id, :user_id, :rating, :comment, NOW())"
            }
          },
          {
            "type": "action.reply_template.v1",
            "params": {
              "text": "üôè –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤!\n\n‚≠ê –û—Ü–µ–Ω–∫–∞: {{rating}}/5\nüí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {{comment}}\n\n‚è∞ –°–ª–µ–¥—É—é—â–∏–π –æ—Ç–∑—ã–≤ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç."
            }
          }
        ]
      }
    },
    {
      "type": "flow.wizard.v1",
      "entry_cmd": "/status",
      "params": {
        "on_enter": [
          {
            "type": "policy.ratelimit.v1",
            "params": {
              "scope": "chat",
              "window_s": 60,
              "allowance": 10,
              "message": "üí¨ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å—Ç–∞—Ç—É—Å–∞ –≤ —ç—Ç–æ–º —á–∞—Ç–µ. –ü–æ–¥–æ–∂–¥–∏—Ç–µ {{retry_in}} —Å–µ–∫."
            }
          },
          {
            "type": "action.sql_query.v1",
            "params": {
              "sql": "SELECT service, to_char(slot,'YYYY-MM-DD HH24:MI') AS slot_time FROM bookings WHERE bot_id=:bot_id AND user_id=:user_id AND slot > NOW() ORDER BY slot LIMIT 3",
              "result_var": "upcoming_bookings"
            }
          },
          {
            "type": "action.reply_template.v1",
            "params": {
              "text": "üìä –í–∞—à —Å—Ç–∞—Ç—É—Å:\n\nüìÖ –ë–ª–∏–∂–∞–π—à–∏–µ –∑–∞–ø–∏—Å–∏:\n{{#each upcoming_bookings}}‚Ä¢ {{service}} - {{slot_time}}\n{{/each}}",
              "empty_text": "üìä –í–∞—à —Å—Ç–∞—Ç—É—Å:\n\nüìÖ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –∑–∞–ø–∏—Å–µ–π\n\nüí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /book –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏",
              "keyboard": [
                {"text": "üìÖ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å", "callback": "/book"},
                {"text": "üìù –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤", "callback": "/feedback"}
              ]
            }
          }
        ]
      }
    },
    {
      "type": "flow.wizard.v1",
      "entry_cmd": "/admin_reset",
      "params": {
        "on_enter": [
          {
            "type": "policy.ratelimit.v1",
            "params": {
              "scope": "bot",
              "window_s": 3600,
              "allowance": 5,
              "key_suffix": "admin:reset",
              "message": "üîí –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã. –¢–æ–ª—å–∫–æ 5 —Å–±—Ä–æ—Å–æ–≤ –≤ —á–∞—Å. –ü–æ–¥–æ–∂–¥–∏—Ç–µ {{retry_in}} —Å–µ–∫."
            }
          },
          {
            "type": "action.sql_exec.v1",
            "params": {
              "sql": "DELETE FROM bookings WHERE bot_id=:bot_id AND created_at < NOW() - INTERVAL '7 days'"
            }
          },
          {
            "type": "action.reply_template.v1",
            "params": {
              "text": "üóëÔ∏è –°—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ (7+ –¥–Ω–µ–π) —É–¥–∞–ª–µ–Ω—ã\n\n‚è∞ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: 5 —Å–±—Ä–æ—Å–æ–≤ –≤ —á–∞—Å"
            }
          }
        ]
      }
    },
    {
      "type": "flow.wizard.v1",
      "entry_cmd": "/spam_test",
      "params": {
        "on_enter": [
          {
            "type": "policy.ratelimit.v1",
            "params": {
              "scope": "user",
              "window_s": 10,
              "allowance": 1,
              "key_suffix": "test",
              "message": "üö´ –¢–µ—Å—Ç –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞: 1 —Ä–∞–∑ –≤ 10 —Å–µ–∫—É–Ω–¥. –û—Å—Ç–∞–ª–æ—Å—å {{retry_in}} —Å–µ–∫."
            }
          },
          {
            "type": "action.reply_template.v1",
            "params": {
              "text": "‚úÖ –¢–µ—Å—Ç –ø—Ä–æ—à–µ–ª! –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç.\n\n‚è∞ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥."
            }
          }
        ]
      }
    }
  ]
}