{
  "use": [
    "flow.wizard.v1",
    "widget.pagination.v1",
    "action.sql_exec.v1",
    "action.sql_query.v1",
    "action.reply_template.v1"
  ],
  "intents": [
    {"cmd": "/start", "reply": "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: /services, /my_bookings, /cancel_booking"}
  ],
  "flows": [
    {
      "type": "flow.wizard.v1",
      "entry_cmd": "/services",
      "params": {
        "steps": [
          {
            "widget": {
              "type": "widget.pagination.v1",
              "params": {
                "source": {
                  "type": "sql",
                  "sql": "SELECT id, title, price FROM services WHERE bot_id=:bot_id AND active=true ORDER BY title LIMIT :limit OFFSET :offset"
                },
                "page_size": 5,
                "item_template": "‚Ä¢ {{title}} - {{price}}‚ÇΩ",
                "select_callback": "/pick_service",
                "id_field": "id",
                "title": "–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É:",
                "empty_text": "–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥",
                "extra_keyboard": [
                  {"text": "üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", "callback": "/start"}
                ]
              }
            },
            "var": "service_id"
          },
          {
            "widget": {
              "type": "widget.calendar.v1",
              "params": {
                "mode": "datetime",
                "title": "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è",
                "min": "2025-01-01",
                "max": "2025-12-31"
              }
            },
            "var": "slot"
          }
        ],
        "on_complete": [
          {
            "type": "action.sql_exec.v1",
            "params": {
              "sql": "INSERT INTO bookings(bot_id, user_id, service_id, slot, created_at) VALUES(:bot_id, :user_id, :service_id, :slot::timestamptz, NOW())"
            }
          },
          {
            "type": "action.reply_template.v1",
            "params": {
              "text": "‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞!\n–£—Å–ª—É–≥–∞ ID: {{service_id}}\n–í—Ä–µ–º—è: {{slot}}"
            }
          }
        ]
      }
    },
    {
      "type": "flow.wizard.v1",
      "entry_cmd": "/my_bookings",
      "params": {
        "on_enter": [
          {
            "type": "action.sql_query.v1",
            "params": {
              "sql": "SELECT b.id, s.title, to_char(b.slot,'YYYY-MM-DD HH24:MI') AS slot_time FROM bookings b JOIN services s ON b.service_id = s.id WHERE b.bot_id=:bot_id AND b.user_id=:user_id AND b.slot > NOW() ORDER BY b.slot",
              "result_var": "my_bookings"
            }
          }
        ],
        "steps": [
          {
            "widget": {
              "type": "widget.pagination.v1",
              "params": {
                "source": {
                  "type": "ctx",
                  "ctx_var": "my_bookings"
                },
                "page_size": 3,
                "item_template": "{{title}} - {{slot_time}}",
                "select_callback": "/show_booking",
                "id_field": "id",
                "title": "–í–∞—à–∏ –∑–∞–ø–∏—Å–∏:",
                "empty_text": "–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π",
                "extra_keyboard": [
                  {"text": "üìÖ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å", "callback": "/services"},
                  {"text": "üîô –ù–∞–∑–∞–¥", "callback": "/start"}
                ]
              }
            },
            "var": "booking_id"
          }
        ],
        "on_complete": [
          {
            "type": "action.sql_query.v1",
            "params": {
              "sql": "SELECT s.title, to_char(b.slot,'YYYY-MM-DD HH24:MI') AS slot_time, s.price FROM bookings b JOIN services s ON b.service_id = s.id WHERE b.id=:booking_id AND b.bot_id=:bot_id AND b.user_id=:user_id",
              "result_var": "booking_info",
              "scalar": false
            }
          },
          {
            "type": "action.reply_template.v1",
            "params": {
              "text": "üìã –ó–∞–ø–∏—Å—å:\n{{#each booking_info}}‚Ä¢ {{title}}\n‚Ä¢ {{slot_time}}\n‚Ä¢ {{price}}‚ÇΩ{{/each}}",
              "keyboard": [
                {"text": "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å", "callback": "/cancel_booking"},
                {"text": "üîô –ö —Å–ø–∏—Å–∫—É", "callback": "/my_bookings"}
              ]
            }
          }
        ]
      }
    },
    {
      "type": "flow.wizard.v1",
      "entry_cmd": "/cancel_booking",
      "params": {
        "on_enter": [
          {
            "type": "action.sql_query.v1",
            "params": {
              "sql": "SELECT b.id, s.title, to_char(b.slot,'YYYY-MM-DD HH24:MI') AS slot_time FROM bookings b JOIN services s ON b.service_id = s.id WHERE b.bot_id=:bot_id AND b.user_id=:user_id AND b.slot > NOW() ORDER BY b.slot",
              "result_var": "cancellable_bookings"
            }
          }
        ],
        "steps": [
          {
            "widget": {
              "type": "widget.pagination.v1",
              "params": {
                "source": {
                  "type": "ctx",
                  "ctx_var": "cancellable_bookings"
                },
                "page_size": 5,
                "item_template": "{{title}} - {{slot_time}}",
                "select_callback": "/confirm_cancel",
                "id_field": "id",
                "title": "–ö–∞–∫—É—é –∑–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å?",
                "empty_text": "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ—Ç–º–µ–Ω—ã",
                "extra_keyboard": [
                  {"text": "üîô –ù–∞–∑–∞–¥", "callback": "/my_bookings"}
                ]
              }
            },
            "var": "cancel_booking_id"
          }
        ],
        "on_complete": [
          {
            "type": "action.sql_exec.v1",
            "params": {
              "sql": "DELETE FROM bookings WHERE id=:cancel_booking_id AND bot_id=:bot_id AND user_id=:user_id"
            }
          },
          {
            "type": "action.reply_template.v1",
            "params": {
              "text": "‚ùå –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞\n\n–í–∞—à–∏ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–ø–∏—Å–∏: /my_bookings",
              "keyboard": [
                {"text": "üìÖ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å", "callback": "/services"},
                {"text": "üìã –ú–æ–∏ –∑–∞–ø–∏—Å–∏", "callback": "/my_bookings"},
                {"text": "üè† –ì–ª–∞–≤–Ω–∞—è", "callback": "/start"}
              ]
            }
          }
        ]
      }
    }
  ]
}