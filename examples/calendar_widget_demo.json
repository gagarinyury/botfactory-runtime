{
  "use": [
    "flow.wizard.v1",
    "flow.menu.v1",
    "widget.calendar.v1",
    "action.sql_exec.v1",
    "action.sql_query.v1",
    "action.reply_template.v1"
  ],
  "intents": [
    {
      "cmd": "/help",
      "reply": "üìÖ –î–µ–º–æ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –≤–∏–¥–∂–µ—Ç–∞:\n\nüóìÔ∏è /book_date - –≤—ã–±–æ—Ä –¥–∞—Ç—ã\nüïê /book_datetime - –≤—ã–±–æ—Ä –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏\nüìã /my_appointments - –º–æ–∏ –∑–∞–ø–∏—Å–∏\nüè† /start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
    }
  ],
  "flows": [
    {
      "type": "flow.menu.v1",
      "entry_cmd": "/start",
      "params": {
        "title": "üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –≤–∏–¥–∂–µ—Ç - –î–µ–º–æ\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        "options": [
          {"text": "üóìÔ∏è –í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É", "callback": "/book_date"},
          {"text": "üïê –í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è", "callback": "/book_datetime"},
          {"text": "üìã –ú–æ–∏ –∑–∞–ø–∏—Å–∏", "callback": "/my_appointments"},
          {"text": "‚ùì –°–ø—Ä–∞–≤–∫–∞", "callback": "/help"}
        ]
      }
    },
    {
      "type": "flow.wizard.v1",
      "entry_cmd": "/book_date",
      "params": {
        "steps": [
          {
            "widget": {
              "type": "widget.calendar.v1",
              "params": {
                "mode": "date",
                "var": "appointment_date",
                "title": "üóìÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∑–∞–ø–∏—Å–∏",
                "min": "2025-01-01",
                "max": "2025-12-31"
              }
            }
          },
          {
            "ask": "üìù –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏:\n\n–ü—Ä–∏–º–µ—Ä: –í—Å—Ç—Ä–µ—á–∞ —Å –≤—Ä–∞—á–æ–º, –î–µ–ª–æ–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞, –õ–∏—á–Ω–æ–µ –¥–µ–ª–æ",
            "var": "appointment_title"
          }
        ],
        "on_complete": [
          {
            "type": "action.sql_exec.v1",
            "params": {
              "sql": "INSERT INTO appointments(bot_id, user_id, date, title, type, created_at) VALUES(:bot_id, :user_id, :appointment_date, :appointment_title, 'date_only', NOW())"
            }
          },
          {
            "type": "action.reply_template.v1",
            "params": {
              "text": "‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞!\n\nüìÖ –î–∞—Ç–∞: {{appointment_date}}\nüìù –ù–∞–∑–≤–∞–Ω–∏–µ: {{appointment_title}}\n\n–ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –≤–∞—à–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–µ.",
              "keyboard": [
                {"text": "üìã –ú–æ–∏ –∑–∞–ø–∏—Å–∏", "callback": "/my_appointments"},
                {"text": "‚ûï –°–æ–∑–¥–∞—Ç—å –µ—â—ë", "callback": "/start"},
                {"text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "callback": "/start"}
              ]
            }
          }
        ]
      }
    },
    {
      "type": "flow.wizard.v1",
      "entry_cmd": "/book_datetime",
      "params": {
        "steps": [
          {
            "widget": {
              "type": "widget.calendar.v1",
              "params": {
                "mode": "datetime",
                "var": "appointment_datetime",
                "title": "üïê –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏",
                "min": "2025-01-01",
                "max": "2025-06-30",
                "tz": "Europe/Moscow"
              }
            }
          },
          {
            "ask": "üìù –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏:\n\n–ü—Ä–∏–º–µ—Ä: –í—Å—Ç—Ä–µ—á–∞ —Å –∫–ª–∏–µ–Ω—Ç–æ–º, –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –æ—Å–º–æ—Ç—Ä",
            "var": "appointment_title"
          },
          {
            "ask": "üë§ –£–∫–∞–∂–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):\n\n–í–≤–µ–¥–∏—Ç–µ –∏–º–µ–Ω–∞ –∏–ª–∏ '–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å':",
            "var": "participants"
          }
        ],
        "on_complete": [
          {
            "type": "action.sql_exec.v1",
            "params": {
              "sql": "INSERT INTO appointments(bot_id, user_id, datetime, title, participants, type, created_at) VALUES(:bot_id, :user_id, to_timestamp(:appointment_datetime, 'YYYY-MM-DD HH24:MI'), :appointment_title, CASE WHEN :participants = '–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å' THEN NULL ELSE :participants END, 'datetime', NOW())"
            }
          },
          {
            "type": "action.reply_template.v1",
            "params": {
              "text": "‚úÖ –í—Å—Ç—Ä–µ—á–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞!\n\nüïê –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: {{appointment_datetime}}\nüìù –ù–∞–∑–≤–∞–Ω–∏–µ: {{appointment_title}}\nüë• –£—á–∞—Å—Ç–Ω–∏–∫–∏: {{participants}}\n\nüîî –ú—ã –Ω–∞–ø–æ–º–Ω–∏–º –≤–∞–º –∑–∞ 15 –º–∏–Ω—É—Ç –¥–æ –≤—Å—Ç—Ä–µ—á–∏.",
              "keyboard": [
                {"text": "üìã –ú–æ–∏ –∑–∞–ø–∏—Å–∏", "callback": "/my_appointments"},
                {"text": "‚ûï –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë", "callback": "/book_datetime"},
                {"text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "callback": "/start"}
              ]
            }
          }
        ]
      }
    },
    {
      "entry_cmd": "/my_appointments",
      "on_enter": [
        {
          "type": "action.sql_query.v1",
          "params": {
            "sql": "SELECT COALESCE(to_char(datetime, 'DD.MM.YYYY HH24:MI'), date) as display_date, title, participants, type FROM appointments WHERE bot_id=:bot_id AND user_id=:user_id ORDER BY COALESCE(datetime, date::timestamp) DESC LIMIT 10",
            "result_var": "appointments"
          }
        },
        {
          "type": "action.reply_template.v1",
          "params": {
            "text": "üìã –í–∞—à–∏ –∑–∞–ø–∏—Å–∏:\n\n{{#each appointments}}üìÖ {{display_date}}\nüìù {{title}}{{#if participants}}\nüë• {{participants}}{{/if}}\n{{#if type}}üè∑Ô∏è {{type}}{{/if}}\n\n{{/each}}",
            "empty_text": "üì≠ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π\n\n–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å!",
            "keyboard": [
              {"text": "üóìÔ∏è –í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É", "callback": "/book_date"},
              {"text": "üïê –î–∞—Ç–∞ + –≤—Ä–µ–º—è", "callback": "/book_datetime"},
              {"text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "callback": "/start"}
            ]
          }
        }
      ]
    }
  ]
}